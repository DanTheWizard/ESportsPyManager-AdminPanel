{% extends "base.html" %}
{% block title %}Manage Devices - Admin Panel{% endblock %}
{% block content %}


<h2>ğŸ“‹ Unregistered Devices (Online Only)</h2>
<table border="1">
    <tr>
        <th>Machine ID</th>
        <th>Hostname</th>
        <th>Action</th>
    </tr>
    {% for device in unregistered %}
    <tr>
        <td>
            <button
                type="button"
                class="identify-btn"
                data-machine-id="{{ device.machine_id }}"
                title="Make this PC identify itself"
            >
                Identify
            </button>
            {{ device.machine_id }}
        </td>
        <td>{{ device.hostname }}</td>
        <td>
            <form method="POST" action="{{ url_for('app_routes.register_from_manage') }}">
                <input type="hidden" name="machine_id" value="{{ device.machine_id }}">
                <input type="text" name="nickname" placeholder="Enter nickname" required>
                <button type="submit">Register</button>
            </form>
        </td>
    </tr>
    {% endfor %}
</table>

<hr>

<h2>ğŸ” Registered Devices</h2>
<table border="1">
    <tr>
        <th>Nickname</th>
        <th>Machine ID</th>
        <th>Registered</th>
        <th>Action</th>
    </tr>
    {% for device in registered %}
    <tr>
        <td>{{ device.nickname }}</td>
        <td>{{ device.machine_id }}</td>
        <td>{{ device.registered_at }}</td>
        <td>
            <form method="POST" action="{{ url_for('app_routes.deregister_device') }}">
                <input type="hidden" name="machine_id" value="{{ device.machine_id }}">
                <button type="submit">Delete</button>
            </form>
        </td>
    </tr>
    {% endfor %}
</table>


<script>
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".identify-btn").forEach(button => {
    button.addEventListener("click", () => {
      const machineId = button.dataset.machineId;

      const form = new URLSearchParams();
      form.append("machine_id", machineId);
      form.append("action", "ID");
      form.append("argument", "");

      fetch("{{ url_for('app_routes.send_action_device') }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: form.toString()
      })
      .then(r => r.json())
      .then(json => {
        if (json.status === "success") {
          alert(`âœ… Identify signal sent to ${machineId}`);
        } else {
          alert(`âš ï¸ Error: ${json.message || 'Unknown error'}`);
        }
      })
      .catch(err => {
        alert(`âŒ Request failed: ${err}`);
      });
    });
  });
});
</script>


{% endblock %}