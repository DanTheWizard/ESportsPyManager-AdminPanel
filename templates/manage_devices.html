{% extends "base.html" %}
{% block title %}Manage Devices - Admin Panel{% endblock %}
{% block content %}


<h2>üìã Unregistered Devices (Online Only)</h2>
<table border="1">
    <tr>
        <th>Machine ID</th>
        <th>Hostname</th>
        <th>Tag</th>
        <th>Nickname</th>
    </tr>
    {% for device in unregistered %}
    <form method="POST" action="{{ url_for('api_routes.register_from_manage') }}">
        <tr>
            <td>
                <button
                    type="button"
                    class="identify-btn"
                    data-machine-id="{{ device.machine_id }}"
                    title="Make this PC identify itself"
                >
                    Identify
                </button>
                {{ device.machine_id }}
            </td>
            <td>{{ device.hostname }}</td>
            <td>
                <label>
                    <select name="tag">
                        {% for tag in DEVICE_TAGS %}
                            <option value="{{ tag }}">{{ tag }}</option>
                        {% endfor %}
                    </select>
                </label>
            </td>
            <td>
                <input type="hidden" name="machine_id" value="{{ device.machine_id }}">
                <label>
                    <input type="text" name="nickname" placeholder="Enter nickname" required>
                </label>
                <button type="submit">Register</button>
            </td>
        </tr>
    </form>
    {% endfor %}
</table>

<hr>

<h2>üîê Registered Devices</h2>
<table border="1">
    <tr>
        <th>Nickname</th>
        <th>Machine ID</th>
        <th>Registered At</th>
        <th>Tag</th>
        <th>Action</th>
    </tr>
    {% for device in registered %}
    <tr>
        <td>{{ device.nickname }}</td>
        <td>{{ device.machine_id }}</td>
        <td>{{ device.registered_at }}</td>
        <td>{{ device.tag }}</td>
        <td>
            <form method="POST" action="{{ url_for('api_routes.deregister_device') }}">
                <input type="hidden" name="machine_id" value="{{ device.machine_id }}">
                <button type="submit">Delete</button>
            </form>
        </td>
    </tr>
    {% endfor %}
</table>


<script>
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".identify-btn").forEach(button => {
    button.addEventListener("click", () => {
      const machineId = button.dataset.machineId;

      const form = new URLSearchParams();
      form.append("machine_id", machineId);
      form.append("action", "ID");
      form.append("argument", "");

      fetch("{{ url_for('api_routes.send_action_device') }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: form.toString()
      })
      .then(r => r.json())
      .then(json => {
        if (json.status === "success") {
          alert(`‚úÖ Identify signal sent to ${machineId}`);
        } else {
          alert(`‚ö†Ô∏è Error: ${json.message || 'Unknown error'}`);
        }
      })
      .catch(err => {
        alert(`‚ùå Request failed: ${err}`);
      });
    });
  });
});
</script>


{% endblock %}